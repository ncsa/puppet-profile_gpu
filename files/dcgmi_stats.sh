#!/bin/bash
# This file is managed by Puppet

gpu_model=$(lspci | grep "controller: NVIDIA Corporation" | head -n 1 | grep -o -P '(?<=Corporation\ ).*(?=\ ?\[)' | xargs)
case ${gpu_model} in
	GM204GL|GM200GL|TU104GL|GA102GL)
		while read -r p; do
			IFS=" " read -r DCGM_FI_DEV_NAME DCGM_FI_DEV_UUID DCGM_FI_DEV_MINOR_NUMBER DCGM_FI_DEV_SM_CLOCK DCGM_FI_DEV_MEM_CLOCK DCGM_FI_DEV_GPU_TEMP DCGM_FI_DEV_POWER_USAGE DCGM_FI_DEV_GPU_UTIL DCGM_FI_DEV_MEM_COPY_UTIL DCGM_FI_DEV_XID_ERRORS DCGM_FI_DEV_POWER_VIOLATION DCGM_FI_DEV_THERMAL_VIOLATION DCGM_FI_DEV_FB_TOTAL DCGM_FI_DEV_FB_FREE DCGM_FI_DEV_FB_USED DCGM_FI_DEV_FB_RESERVED DCGM_FI_DEV_FB_USED_PERCENT DCGM_FI_DEV_ECC_SBE_VOL_TOTAL DCGM_FI_DEV_ECC_DBE_VOL_TOTAL DCGM_FI_DEV_ECC_SBE_AGG_TOTAL DCGM_FI_DEV_ECC_DBE_AGG_TOTAL DCGM_FI_DEV_RETIRED_SBE DCGM_FI_DEV_RETIRED_DBE DCGM_FI_DEV_RETIRED_PENDING <<< $(echo ${p})
			echo "dcgm,gpu_type=${DCGM_FI_DEV_NAME},gpu_uuid=${DCGM_FI_DEV_UUID},gpu_id=${DCGM_FI_DEV_MINOR_NUMBER} DCGM_FI_DEV_SM_CLOCK=${DCGM_FI_DEV_SM_CLOCK},DCGM_FI_DEV_MEM_CLOCK=${DCGM_FI_DEV_MEM_CLOCK},DCGM_FI_DEV_GPU_TEMP=${DCGM_FI_DEV_GPU_TEMP},DCGM_FI_DEV_POWER_USAGE=${DCGM_FI_DEV_POWER_USAGE},DCGM_FI_DEV_GPU_UTIL=${DCGM_FI_DEV_GPU_UTIL},DCGM_FI_DEV_MEM_COPY_UTIL=${DCGM_FI_DEV_MEM_COPY_UTIL},DCGM_FI_DEV_XID_ERRORS=${DCGM_FI_DEV_XID_ERRORS},DCGM_FI_DEV_POWER_VIOLATION=${DCGM_FI_DEV_POWER_VIOLATION},DCGM_FI_DEV_THERMAL_VIOLATION=${DCGM_FI_DEV_THERMAL_VIOLATION},DCGM_FI_DEV_FB_TOTAL=${DCGM_FI_DEV_FB_TOTAL},DCGM_FI_DEV_FB_FREE=${DCGM_FI_DEV_FB_FREE},DCGM_FI_DEV_FB_USED=${DCGM_FI_DEV_FB_USED},DCGM_FI_DEV_FB_RESERVED=${DCGM_FI_DEV_FB_RESERVED},DCGM_FI_DEV_FB_USED_PERCENT=${DCGM_FI_DEV_FB_USED_PERCENT},DCGM_FI_DEV_ECC_SBE_VOL_TOTAL=${DCGM_FI_DEV_ECC_SBE_VOL_TOTAL},DCGM_FI_DEV_ECC_DBE_VOL_TOTAL=${DCGM_FI_DEV_ECC_DBE_VOL_TOTAL},DCGM_FI_DEV_ECC_SBE_AGG_TOTAL=${DCGM_FI_DEV_ECC_SBE_AGG_TOTAL},DCGM_FI_DEV_ECC_DBE_AGG_TOTAL=${DCGM_FI_DEV_ECC_DBE_AGG_TOTAL},DCGM_FI_DEV_RETIRED_SBE=${DCGM_FI_DEV_RETIRED_SBE},DCGM_FI_DEV_RETIRED_DBE=${DCGM_FI_DEV_RETIRED_DBE},DCGM_FI_DEV_RETIRED_PENDING=${DCGM_FI_DEV_RETIRED_PENDING}"
		done < <(dcgmi dmon -e 50,54,55,100,101,150,155,203,204,230,240,241,250,251,252,253,254,310,311,312,313,390,391,392 -c 1 | tail -n +3 | cut -d' ' -f 7- | sed -e 's/\b \b/_/g' | sed 's/N\/A/0/g')
		;;
	GA100|GV100GL|GH100)
		while read -r p; do
                        IFS=" " read -r DCGM_FI_DEV_NAME DCGM_FI_DEV_UUID DCGM_FI_DEV_MINOR_NUMBER DCGM_FI_DEV_SM_CLOCK DCGM_FI_DEV_MEM_CLOCK DCGM_FI_DEV_GPU_TEMP DCGM_FI_DEV_POWER_USAGE DCGM_FI_DEV_GPU_UTIL DCGM_FI_DEV_MEM_COPY_UTIL DCGM_FI_DEV_XID_ERRORS DCGM_FI_DEV_POWER_VIOLATION DCGM_FI_DEV_THERMAL_VIOLATION DCGM_FI_DEV_FB_TOTAL DCGM_FI_DEV_FB_FREE DCGM_FI_DEV_FB_USED DCGM_FI_DEV_FB_RESERVED DCGM_FI_DEV_FB_USED_PERCENT DCGM_FI_DEV_ECC_SBE_VOL_TOTAL DCGM_FI_DEV_ECC_DBE_VOL_TOTAL DCGM_FI_DEV_ECC_SBE_AGG_TOTAL DCGM_FI_DEV_ECC_DBE_AGG_TOTAL DCGM_FI_DEV_RETIRED_SBE DCGM_FI_DEV_RETIRED_DBE DCGM_FI_DEV_RETIRED_PENDING PROF_GR_ENGINE_ACTIVE PROF_SM_ACTIVE PROF_SM_OCCUPANCY PROF_PIPE_TENSOR_ACTIVE PROF_DRAM_ACTIVE PROF_PIPE_FP64_ACTIVE PROF_PIPE_FP32_ACTIVE PROF_PIPE_FP16_ACTIVE PROF_PCIE_TX_BYTES PROF_PCIE_RX_BYTES PROF_NVLINK_TX_BYTES PROF_NVLINK_RX_BYTES <<< $(echo ${p})
                        echo "dcgm,gpu_type=${DCGM_FI_DEV_NAME},gpu_uuid=${DCGM_FI_DEV_UUID},gpu_id=${DCGM_FI_DEV_MINOR_NUMBER} DCGM_FI_DEV_SM_CLOCK=${DCGM_FI_DEV_SM_CLOCK},DCGM_FI_DEV_MEM_CLOCK=${DCGM_FI_DEV_MEM_CLOCK},DCGM_FI_DEV_GPU_TEMP=${DCGM_FI_DEV_GPU_TEMP},DCGM_FI_DEV_POWER_USAGE=${DCGM_FI_DEV_POWER_USAGE},DCGM_FI_DEV_GPU_UTIL=${DCGM_FI_DEV_GPU_UTIL},DCGM_FI_DEV_MEM_COPY_UTIL=${DCGM_FI_DEV_MEM_COPY_UTIL},DCGM_FI_DEV_XID_ERRORS=${DCGM_FI_DEV_XID_ERRORS},DCGM_FI_DEV_POWER_VIOLATION=${DCGM_FI_DEV_POWER_VIOLATION},DCGM_FI_DEV_THERMAL_VIOLATION=${DCGM_FI_DEV_THERMAL_VIOLATION},DCGM_FI_DEV_FB_TOTAL=${DCGM_FI_DEV_FB_TOTAL},DCGM_FI_DEV_FB_FREE=${DCGM_FI_DEV_FB_FREE},DCGM_FI_DEV_FB_USED=${DCGM_FI_DEV_FB_USED},DCGM_FI_DEV_FB_RESERVED=${DCGM_FI_DEV_FB_RESERVED},DCGM_FI_DEV_FB_USED_PERCENT=${DCGM_FI_DEV_FB_USED_PERCENT},DCGM_FI_DEV_ECC_SBE_VOL_TOTAL=${DCGM_FI_DEV_ECC_SBE_VOL_TOTAL},DCGM_FI_DEV_ECC_DBE_VOL_TOTAL=${DCGM_FI_DEV_ECC_DBE_VOL_TOTAL},DCGM_FI_DEV_ECC_SBE_AGG_TOTAL=${DCGM_FI_DEV_ECC_SBE_AGG_TOTAL},DCGM_FI_DEV_ECC_DBE_AGG_TOTAL=${DCGM_FI_DEV_ECC_DBE_AGG_TOTAL},DCGM_FI_DEV_RETIRED_SBE=${DCGM_FI_DEV_RETIRED_SBE},DCGM_FI_DEV_RETIRED_DBE=${DCGM_FI_DEV_RETIRED_DBE},DCGM_FI_DEV_RETIRED_PENDING=${DCGM_FI_DEV_RETIRED_PENDING},PROF_GR_ENGINE_ACTIVE=${PROF_GR_ENGINE_ACTIVE},PROF_SM_ACTIVE=${PROF_SM_ACTIVE},PROF_SM_OCCUPANCY=${PROF_SM_OCCUPANCY},PROF_PIPE_TENSOR_ACTIVE=${PROF_PIPE_TENSOR_ACTIVE},PROF_DRAM_ACTIVE=${PROF_DRAM_ACTIVE},PROF_PIPE_FP64_ACTIVE=${PROF_PIPE_FP64_ACTIVE},PROF_PIPE_FP32_ACTIVE=${PROF_PIPE_FP32_ACTIVE},PROF_PIPE_FP16_ACTIVE=${PROF_PIPE_FP16_ACTIVE},PROF_PCIE_TX_BYTES=${PROF_PCIE_TX_BYTES},PROF_PCIE_RX_BYTES=${PROF_PCIE_RX_BYTES},PROF_NVLINK_TX_BYTES=${PROF_NVLINK_TX_BYTES},PROF_NVLINK_RX_BYTES=${PROF_NVLINK_RX_BYTES}"
                done < <(dcgmi dmon -e 50,54,55,100,101,150,155,203,204,230,240,241,250,251,252,253,254,310,311,312,313,390,391,392,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012 -c 1 | tail -n +3 | cut -d' ' -f 7- | sed -e 's/\b \b/_/g' | sed 's/N\/A/0/g')
		;;
esac
